<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>爆益ガチャ未来予測シミュレーター（暗号資産）</title>

  <!-- OGP -->
  <meta property="og:title" content="爆益ガチャ未来予測シミュレーター（暗号資産）">
  <meta property="og:description" content="ガチャで引いた暗号資産の未来（楽観/現実/悲観）を一発シミュレーション。">
  <meta property="og:type" content="website">
  <meta property="og:image" content="./ogp.png">
  <meta name="twitter:card" content="summary_large_image">

  <style>
    :root{
      --bg:#0b0f1a; --panel:#12172a; --panel2:#0f1324;
      --text:#e6e9f2; --muted:#9aa3b2;
      --accent:#7c5cff; --good:#32d583;
      --warn:#f79009; --bad:#ff6b6b;
      --gold:#ffd166; --cyan:#67e8f9;
      --pink:#ff7ab6;
    }
    body{margin:0; background:#0b0f1a; color:var(--text);
      font-family: system-ui, -apple-system, "Noto Sans JP", sans-serif;}
    .wrap{max-width:1100px; margin:0 auto; padding:0 12px 24px;}
    header{padding:18px 16px; background:#0b0f1ad0; position:sticky; top:0;}
    .title{font-size:20px; font-weight:700;}
    .subtitle{font-size:12px; color:var(--muted);}
    .grid{display:grid; gap:12px; grid-template-columns:1.1fr .9fr;}
    @media(max-width:900px){.grid{grid-template-columns:1fr;}}

    .card{background:linear-gradient(180deg,var(--panel),var(--panel2));
      border:1px solid #ffffff10; border-radius:16px; padding:14px;}

    label{font-size:12px; color:var(--muted);}
    input,select{
      width:100%; padding:8px; border-radius:10px;
      background:#0b1020; border:1px solid #ffffff20; color:var(--text);
    }
    button{
      padding:10px 12px; border-radius:12px; border:none;
      cursor:pointer; font-weight:700;
      background:var(--accent); color:white;
    }
    button.secondary{
      background:#141a31; border:1px solid #ffffff20; color:#cfd6e6;
    }

    .results{display:grid; gap:10px;}
    .coin-row{
      background:#0c1226; border:1px dashed #ffffff20;
      border-radius:12px; padding:10px;
      display:grid; grid-template-columns:1fr auto; gap:8px;
    }
    .coin-name{font-weight:700;}
    .rarity{padding:3px 6px; border-radius:999px; font-size:11px; margin-left:6px;}
    .rarity.LR{background:linear-gradient(90deg,#fff,#ffd166,#ff7ab6); color:#111;}
    .rarity.UR{background:linear-gradient(90deg,#b6f3ff,#67e8f9,#7c5cff); color:#111;}
    .rarity.SSR{background:var(--gold); color:#111;}
    .rarity.SR{background:#b6f3ff; color:#111;}
    .rarity.R{background:#2a3150;}
    .rarity.N{background:#1b223b;}

    .future-grid{display:grid; grid-template-columns:repeat(3,1fr); gap:8px; margin-top:8px;}
    .future{background:#0b1020; border:1px solid #ffffff10; border-radius:10px; padding:8px;}
    .good{color:var(--good);} .warn{color:var(--warn);} .bad{color:var(--bad);}

    .spark{height:8px; background:#0f1530; border-radius:999px; overflow:hidden;}
    .spark>i{display:block; height:100%; background:linear-gradient(90deg,var(--accent),var(--cyan)); width:0%;}

    /* レア演出 */
    body.flash-rare{animation:rareFlash .9s ease-in-out 1;}
    @keyframes rareFlash{
      0%{filter:brightness(1);}
      20%{filter:brightness(2) saturate(1.5);}
      60%{filter:brightness(1.3);}
      100%{filter:brightness(1);}
    }

    /* 紙吹雪 */
    #confettiCanvas{position:fixed; inset:0; pointer-events:none; z-index:9999;}

    /* 爆益バッジ */
    .boom-badge{
      background:linear-gradient(90deg,#ff7ab6,#ffd166);
      padding:3px 6px; border-radius:999px;
      font-size:11px; font-weight:900; margin-left:6px; color:#111;
    }
  </style>
</head>
<body>
<canvas id="confettiCanvas"></canvas>

<header>
  <div class="wrap">
    <div class="title">爆益ガチャ未来予測シミュレーター（暗号資産）</div>
    <div class="subtitle">UR/LR・爆益99999%対応</div>
  </div>
</header>

<div class="wrap grid">

  <!-- 左：ガチャ設定 -->
  <section class="card">
    <h3>ガチャ設定</h3>

    <label>投資額（円）</label>
    <input id="investJPY" type="number" value="100000">

    <label style="margin-top:6px;">ガチャ回数</label>
    <select id="drawCount">
      <option value="1">1回</option>
      <option value="3">3連</option>
      <option value="10" selected>10連</option>
      <option value="30">30連</option>
    </select>

    <label style="margin-top:6px;">時間軸</label>
    <select id="years">
      <option value="1">1年</option>
      <option value="3">3年</option>
      <option value="5" selected>5年</option>
      <option value="10">10年</option>
    </select>

    <label style="margin-top:6px;">市場レジーム</label>
    <select id="regime">
      <option value="bull">強気</option>
      <option value="base" selected>通常</option>
      <option value="bear">弱気</option>
    </select>

    <div style="margin-top:10px; display:flex; gap:8px;">
      <button id="drawBtn">ガチャを回す</button>
      <button class="secondary" id="resetBtn">リセット</button>
    </div>

    <div style="margin-top:10px;">
      <button class="secondary" id="refreshPrices">CoinGecko価格更新</button>
      <div id="apiLog" style="font-size:12px; color:#9aa3b2; margin-top:6px; display:none;"></div>
    </div>

    <h3 style="margin-top:12px;">レアリティ確率</h3>
    <ul style="font-size:12px; color:var(--muted); line-height:1.6;">
      <li>LR: 0.0000001%</li>
      <li>UR: 0.001%</li>
      <li>SSR: 約0.99999%</li>
      <li>SR: 約8.99991%</li>
      <li>R: 約29.9997%</li>
      <li>N: 約59.9994%</li>
    </ul>
  </section>

  <!-- 右：結果表示 -->
  <section class="card">
    <h3>ガチャ結果</h3>
    <div id="results" class="results"></div>

    <h3 style="margin-top:12px;">累計サマリ</h3>
    <div class="coin-row">
      <div>
        <div style="font-size:12px; color:var(--muted);">累計投資額</div>
        <div id="sumInvest" style="font-size:18px; font-weight:800;">0 円</div>
      </div>
      <div>
        <div style="font-size:12px; color:var(--muted);">現実期待額</div>
        <div id="sumBase" style="font-size:18px; font-weight:800;">0 円</div>
      </div>
    </div>

    <div style="margin-top:6px;">
      <div class="spark"><i id="sparkBar"></i></div>
      <div id="sparkText" style="font-size:12px; color:var(--muted); margin-top:4px;">-</div>
    </div>
  </section>

</div>
<script>
/* ----------------------------------
   COINS（LR/UR/SSR/SR/R/N）
---------------------------------- */
const COINS = [
  {id:"bitcoin",symbol:"BTC",name:"Bitcoin",rarity:"LR",mu:0.55,sigma:0.70},
  {id:"ethereum",symbol:"ETH",name:"Ethereum",rarity:"UR",mu:0.65,sigma:0.90},

  {id:"solana",symbol:"SOL",name:"Solana",rarity:"SSR",mu:0.70,sigma:1.20},
  {id:"binancecoin",symbol:"BNB",name:"Binance",rarity:"SSR",mu:0.40,sigma:0.90},
  {id:"ripple",symbol:"XRP",name:"Ripple",rarity:"SSR",mu:0.35,sigma:1.00},

  {id:"dogecoin",symbol:"DOGE",name:"Dogecoin",rarity:"SR",mu:0.65,sigma:1.40},
  {id:"stepn",symbol:"GMT",name:"GMT",rarity:"SR",mu:0.75,sigma:1.60},
  {id:"green-satoshi-token",symbol:"GST",name:"GST",rarity:"SR",mu:0.85,sigma:1.90},
  {id:"meme-coin",symbol:"MEME",name:"MEME",rarity:"SR",mu:0.85,sigma:2.00},
  {id:"sweatcoin",symbol:"SWEAT",name:"SWEAT",rarity:"SR",mu:0.80,sigma:1.70},

  {id:"apecoin",symbol:"APE",name:"ApeCoin",rarity:"R",mu:0.75,sigma:1.90},
  {id:"arbitrum",symbol:"ARB",name:"Arbitrum",rarity:"R",mu:0.80,sigma:1.85},

  {id:"pepe",symbol:"PEPE",name:"Pepe",rarity:"N",mu:1.10,sigma:2.40},
  {id:"shiba-inu",symbol:"SHIB",name:"Shiba Inu",rarity:"N",mu:0.90,sigma:2.20},
  {id:"floki",symbol:"FLOKI",name:"Floki",rarity:"N",mu:1.00,sigma:2.50},
  {id:"bonk",symbol:"BONK",name:"Bonk",rarity:"N",mu:1.05,sigma:2.60},
  {id:"dogwifcoin",symbol:"WIF",name:"dogwifhat",rarity:"N",mu:1.15,sigma:2.80}
];

/* ----------------------------------
   確率（LR/UR/SSR/SR/R/N）
---------------------------------- */
const RARITY_PROB = [
  {rarity:"LR",  p:0.000000001},
  {rarity:"UR",  p:0.00001},
  {rarity:"SSR", p:0.00999989999},
  {rarity:"SR",  p:0.08999909991},
  {rarity:"R",   p:0.2999969997},
  {rarity:"N",   p:0.5999939994}
];

function pickRarity(){
  const r = Math.random();
  let acc = 0;
  for(const it of RARITY_PROB){
    acc += it.p;
    if(r <= acc) return it.rarity;
  }
  return "N";
}
function pickCoin(r){
  const pool = COINS.filter(c=>c.rarity===r);
  return pool[Math.floor(Math.random()*pool.length)];
}

/* ----------------------------------
   未来予測（楽観/現実/悲観）
---------------------------------- */
const REG = {
  bull:{muMul:1.35, sigmaMul:1.15},
  base:{muMul:1.00, sigmaMul:1.00},
  bear:{muMul:0.55, sigmaMul:1.25}
};

function mult(coin, years, reg){
  const a = REG[reg];
  const mu = coin.mu * a.muMul;
  const s  = coin.sigma * a.sigmaMul;
  return {
    opt: Math.exp(mu*years + 1.036*s*Math.sqrt(years)),
    base:Math.exp(mu*years),
    pes: Math.exp(mu*years - 1.036*s*Math.sqrt(years))
  };
}

let livePricesJPY = {};
let history = [];
/* ----------------------------------
   演出：紙吹雪
---------------------------------- */
const confettiCanvas = document.getElementById("confettiCanvas");
const cctx = confettiCanvas.getContext("2d");
function resizeC(){confettiCanvas.width=innerWidth; confettiCanvas.height=innerHeight;}
resizeC(); addEventListener("resize",resizeC);

let confetti = [];
function boom(power){
  confetti = Array.from({length:power}).map(()=>({
    x:Math.random()*innerWidth,
    y:-10,
    vx:(Math.random()-.5)*3,
    vy:2+Math.random()*5,
    r:3+Math.random()*4,
    rot:Math.random()*Math.PI,
    vr:(Math.random()-.5)*0.2,
    life:140
  }));
  requestAnimationFrame(tick);
}
function tick(){
  cctx.clearRect(0,0,innerWidth,innerHeight);
  confetti.forEach(p=>{
    p.x+=p.vx; p.y+=p.vy; p.rot+=p.vr; p.life--;
    cctx.save();
    cctx.translate(p.x,p.y); cctx.rotate(p.rot);
    cctx.fillStyle="white"; cctx.fillRect(-p.r,-p.r,p.r*2,p.r*2);
    cctx.restore();
  });
  confetti = confetti.filter(p=>p.life>0);
  if(confetti.length) requestAnimationFrame(tick);
}

/* ----------------------------------
   演出：SE
---------------------------------- */
let audioCtx;
function rareSE(type){
  audioCtx = audioCtx || new (AudioContext||webkitAudioContext)();
  const o = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  o.connect(g); g.connect(audioCtx.destination);
  const now = audioCtx.currentTime;

  const seq = {
    SSR:[440,660,880],
    UR:[523,784,1046,1568],
    LR:[880,1320,1760,2200]
  }[type]||[440];

  o.frequency.setValueAtTime(seq[0],now);
  g.gain.setValueAtTime(0.0001,now);
  g.gain.exponentialRampToValueAtTime(0.3,now+0.02);

  seq.forEach((f,i)=>o.frequency.exponentialRampToValueAtTime(f, now+0.12*i));
  g.gain.exponentialRampToValueAtTime(0.0001,now+0.6);

  o.start(now); o.stop(now+0.65);
}

/* ----------------------------------
   演出：統合
---------------------------------- */
function rareEffect(r){
  if(["SSR","UR","LR"].includes(r)){
    document.body.classList.add("flash-rare");
    setTimeout(()=>document.body.classList.remove("flash-rare"),900);
    boom(r==="LR"?260:r==="UR"?210:150);
    rareSE(r);
  }
}

/* ----------------------------------
   爆益バッジ
---------------------------------- */
function boomBadge(mult){
  if(mult>=1000) return "爆益99999%";
  if(mult>=101) return "爆益10000%";
  return "";
}
/* ----------------------------------
   ガチャ実行
---------------------------------- */
function draw(){
  const invest = Number(investJPY.value);
  const count  = Number(drawCount.value);
  const y      = Number(years.value);
  const reg    = regime.value;
  if(invest<=0) return alert("投資額を入れてください");

  const per = invest / count;

  for(let i=0;i<count;i++){
    const r = pickRarity();
    const c = pickCoin(r);
    const m = mult(c,y,reg);

    const h={
      coin:c, invest:per,
      opt:per*m.opt, base:per*m.base, pes:per*m.pes,
      years:y, regime:reg
    };
    history.push(h);
    rareEffect(c.rarity);
  }
  render();
}

function resetHistory(){
  history=[]; results.innerHTML="";
  sumInvest.textContent="0 円";
  sumBase.textContent="0 円";
  sparkBar.style.width="0%";
  sparkText.textContent="-";
}

/* ----------------------------------
   共有画像（DL + Web Share）
---------------------------------- */
function makeImage(h){
  const w=900,hgt=506;
  const cv=document.createElement("canvas");
  cv.width=w; cv.height=hgt;
  const ctx=cv.getContext("2d");

  ctx.fillStyle="#0b0f1a"; ctx.fillRect(0,0,w,hgt);
  ctx.fillStyle="#12172a"; ctx.fillRect(30,30,w-60,hgt-60);

  ctx.fillStyle="#e6e9f2";
  ctx.font="bold 36px system-ui"; ctx.fillText("爆益ガチャ結果",60,90);

  ctx.font="bold 56px system-ui"; ctx.fillText(`${h.coin.name} (${h.coin.symbol})`,60,170);

  ctx.font="bold 28px system-ui"; ctx.fillStyle="#ffd166";
  ctx.fillText(h.coin.rarity,60,220);

  ctx.fillStyle="#e6e9f2"; ctx.font="bold 30px system-ui";
  ctx.fillText(`楽観: ${jpy(h.opt)} (×${(h.opt/h.invest).toFixed(2)})`,60,290);
  ctx.fillText(`現実: ${jpy(h.base)} (×${(h.base/h.invest).toFixed(2)})`,60,340);
  ctx.fillText(`悲観: ${jpy(h.pes)} (×${(h.pes/h.invest).toFixed(2)})`,60,390);

  ctx.fillStyle="#9aa3b2"; ctx.font="20px system-ui";
  ctx.fillText(`時間軸: ${h.years}年 / ${regimeLabel(h.regime)}`,60,450);

  return cv.toDataURL("image/png");
}

async function shareResult(h){
  const url = makeImage(h);

  // DL
  const a=document.createElement("a");
  a.href=url; a.download=`bakueki-${h.coin.symbol}.png`; a.click();

  // Web Share
  try{
    const b=await (await fetch(url)).blob();
    const f=new File([b],`bakueki-${h.coin.symbol}.png`,{type:"image/png"});
    if(navigator.canShare && navigator.canShare({files:[f]})){
      await navigator.share({
        title:"爆益ガチャ結果",
        text:`${h.coin.name} を引いた！`,
        files:[f]
      });
    }
  }catch(e){}
}

/* ----------------------------------
   表示処理
---------------------------------- */
function render(){
  results.innerHTML="";
  const last = history.slice(-Number(drawCount.value));

  last.forEach(h=>{
    const multOpt = h.opt/h.invest;
    const badge = boomBadge(multOpt);

    const row=document.createElement("div");
    row.className="coin-row";
    row.innerHTML=`
      <div>
        <div class="coin-name">
          ${h.coin.name} <span style="color:#9aa3b2;">(${h.coin.symbol})</span>
          <span class="rarity ${h.coin.rarity}">${h.coin.rarity}</span>
          ${badge?`<span class="boom-badge">${badge}</span>`:""}
        </div>
        <div style="font-size:12px;color:#9aa3b2;">
          ${h.years}年 / ${regimeLabel(h.regime)}
        </div>

        <div class="future-grid">
          <div class="future"><div class="label">楽観</div>
            <div class="value good">${jpy(h.opt)}</div></div>
          <div class="future"><div class="label">現実</div>
            <div class="value warn">${jpy(h.base)}</div></div>
          <div class="future"><div class="label">悲観</div>
            <div class="value bad">${jpy(h.pes)}</div></div>
        </div>

        <button class="secondary share-btn" style="margin-top:8px;">結果を共有</button>
      </div>

      <div style="text-align:right;">
        <div style="font-size:12px;color:#9aa3b2;">投資</div>
        <div style="font-size:16px;font-weight:800;">${jpy(h.invest)}</div>
      </div>
    `;
    row.querySelector(".share-btn").onclick=()=>shareResult(h);
    results.appendChild(row);
  });

  summary();
}

function summary(){
  const sumI = history.reduce((s,h)=>s+h.invest,0);
  const sumB = history.reduce((s,h)=>s+h.base,0);
  sumInvest.textContent=jpy(sumI);
  sumBase.textContent=jpy(sumB);

  if(sumI>0){
    const r=(sumB/sumI-1)*100;
    const w=(Math.max(-50,Math.min(200,r))+50)/250*100;
    sparkBar.style.width=w+"%";
    sparkText.textContent=`期待リターン: ${r.toFixed(1)}%`;
  }
}

/* ----------------------------------
   CoinGecko（任意）
---------------------------------- */
async function refreshPrices(){
  apiLog.style.display="block";
  apiLog.textContent="更新中…";
  try{
    const ids=COINS.map(c=>c.id).join(",");
    const url=`https://api.coingecko.com/api/v3/simple/price?ids=${ids}&vs_currencies=jpy`;
    const r=await fetch(url); const d=await r.json();
    livePricesJPY=d; apiLog.textContent="更新完了";
    setTimeout(()=>apiLog.style.display="none",1200);
  }catch(e){
    apiLog.textContent="失敗（レート制限の可能性）";
  }
}

/* ----------------------------------
   util
---------------------------------- */
function jpy(n){return Math.round(n).toLocaleString("ja-JP")+" 円";}
function regimeLabel(r){return r==="bull"?"強気":r==="bear"?"弱気":"通常";}

/* ----------------------------------
   イベント初期化
---------------------------------- */
drawBtn.onclick=draw;
resetBtn.onclick=resetHistory;
refreshPrices.onclick=refreshPrices;
</script>
</body>
</html>
